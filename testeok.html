<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPECTRA - Teste de Daltonismo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --green: #22C55E;
            --dark-green: #16A34A;
            --silver: #C0C0C0;
            --white: #FFFFFF;
            --black: #000000;
            --dark-gray: #1A1A1A;
            --medium-gray: #2D2D2D;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--black);
            color: var(--silver);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--white);
            margin-bottom: 0.5rem;
            animation: fadeIn 0.8s ease-out;
        }

        .subtitle {
            font-size: 1.2rem;
            color: var(--silver);
            margin-bottom: 2rem;
            animation: fadeIn 1s ease-out;
        }

        .progress-container {
            background: var(--dark-gray);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid var(--medium-gray);
            animation: slideUp 0.6s ease-out;
        }

        .progress-text {
            text-align: center;
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--silver);
        }

        .progress-bar {
            background: var(--medium-gray);
            border-radius: 10px;
            height: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            background: var(--white);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .test-area {
            background: var(--dark-gray);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            text-align: center;
            border: 1px solid var(--medium-gray);
            animation: slideUp 0.8s ease-out;
        }

        .plate-container {
            margin: 2rem 0;
            display: flex;
            justify-content: center;
            animation: fadeIn 1.2s ease-out;
        }

        .ishihara-plate {
            width: 350px;
            height: 350px;
            border-radius: 50%;
            position: relative;
            background: var(--white);
            box-shadow: 0 8px 32px rgba(0,0,0,0.7);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--silver);
            transition: transform 0.3s ease;
        }

        .ishihara-plate:hover {
            transform: scale(1.02);
        }

        .mosaic-grid {
            width: 340px;
            height: 340px;
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            grid-template-rows: repeat(24, 1fr);
            gap: 0.3px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--white);
        }

        .mosaic-dot {
            border-radius: 50%;
            aspect-ratio: 1;
            transition: all 0.3s ease;
        }

        .question-area {
            margin: 2rem 0;
            animation: fadeIn 1s ease-out;
        }

        .question {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--white);
        }

        .answer-input {
            width: 120px;
            height: 60px;
            border: 3px solid var(--medium-gray);
            border-radius: 12px;
            font-size: 2rem;
            text-align: center;
            font-weight: bold;
            margin-bottom: 2rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: var(--black);
            color: var(--white);
            animation: fadeIn 1.2s ease-out;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--white);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        }

        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            animation: fadeIn 1.4s ease-out;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--white);
        }

        .btn-secondary {
            background: transparent;
            color: var(--white);
            border: 2px solid var(--white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-screen {
            display: none;
            text-align: center;
            animation: fadeIn 0.8s ease-out;
        }

        .result-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--white);
        }

        .score-display {
            font-size: 3rem;
            font-weight: 800;
            margin: 2rem 0;
            padding: 2rem;
            background: var(--white);
            color: var(--black);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(255, 255, 255, 0.2);
            animation: pulse 2s infinite;
        }

        .result-interpretation {
            background: var(--medium-gray);
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
            border-left: 6px solid var(--white);
            animation: slideUp 0.6s ease-out;
        }

        .result-interpretation h3 {
            color: var(--white);
            margin-bottom: 1rem;
        }

        .warning-box {
            background: var(--medium-gray);
            border: 2px solid var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
            color: var(--silver);
            animation: slideUp 0.8s ease-out;
        }

        .warning-box strong {
            color: var(--white);
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(40px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .title {
                font-size: 2rem;
            }

            .ishihara-plate {
                width: 280px;
                height: 280px;
            }

            .test-area {
                padding: 2rem 1rem;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üîç Teste de Daltonismo</h1>
            <p class="subtitle">Teste de Percep√ß√£o de Cores - Mosaico Ishihara</p>
        </div>

        <div class="progress-container">
            <div class="progress-text" id="progressText">Quest√£o 1 de 6</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Test Screen -->
        <div class="test-area" id="testScreen">
            <div class="plate-container">
                <div class="ishihara-plate" id="ishiharaPlate">
                    <div class="mosaic-grid" id="mosaicGrid">
                        <!-- Mosaic dots will be generated here -->
                    </div>
                </div>
            </div>

            <div class="question-area">
                <div class="question">Que n√∫mero voc√™ consegue ver na imagem acima?</div>
                <input type="text" class="answer-input" id="answerInput" placeholder="?" maxlength="2">
            </div>

            <div class="controls">
                <button class="btn btn-secondary" onclick="skipQuestion()">N√£o consigo ver</button>
                <button class="btn btn-primary" onclick="nextQuestion()">Pr√≥xima ‚Üí</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="test-area results-screen" id="resultsScreen">
            <h2 class="result-title">Resultado do Teste</h2>
            
            <div class="score-display" id="scoreDisplay">
                <!-- Score will be displayed here -->
            </div>

            <div class="result-interpretation" id="resultInterpretation">
                <!-- Interpretation will be displayed here -->
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Aviso Importante:</strong><br>
                Este teste √© apenas uma triagem inicial e n√£o substitui um exame oftalmol√≥gico completo. 
                Para um diagn√≥stico preciso, consulte um oftalmologista especializado.
            </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="restartTest()">Fazer Teste Novamente</button>
            <button class="btn btn-secondary" onclick="window.location.href='index.html'">Voltar ao In√≠cio</button>
        </div>
        </div>
    </div>

    <script>
        // Test configuration - MODIFICADO com as cores mais n√≠tidas
        const testPlates = [
            {
                number: 8,
                colors: {
                    background: ['#bdc160', '#616c1d', '#8b992c'],
                    number: ['#ba544b', '#d3937b', '#b5534d', '#c7856c', '#a25021']
                },
                type: 'protanopia'
            },
            {
                number: 3,
                colors: {
                    background: ['#a8c68f', '#95b37c', '#82a069', '#6f8d56'],
                    number: ['#d4756b', '#c1625a', '#ae4f49', '#9b3c38']
                },
                type: 'deuteranopia'
            },
            {
                number: 5,
                colors: {
                    background: ['#f4c2a1', '#e6b48e', '#d8a67b', '#ca9868'],
                    number: ['#8b6f47', '#7d6140', '#6f5339', '#614532']
                },
                type: 'protanopia'
            },
            {
                number: 6,
                colors: {
                    background: ['#b8d4a8', '#a5c195', '#92ae82', '#7f9b6f'],
                    number: ['#e67e70', '#d36b5d', '#c0584a', '#ad4537']
                },
                type: 'deuteranopia'
            },
            {
                number: 2,
                colors: {
                    background: ['#a8b8d4', '#95a5c1', '#8292ae', '#6f7f9b'],
                    number: ['#d4a874', '#c19561', '#ae824e', '#9b6f3b']
                },
                type: 'tritanopia'
            },
            {
                number: 7,
                colors: {
                    background: ['#d4b8a8', '#c1a595', '#ae9282', '#9b7f6f'],
                    number: ['#74a8d4', '#6195c1', '#4e82ae', '#3b6f9b']
                },
                type: 'tritanopia'
            }
        ];

        let currentQuestion = 0;
        let userAnswers = [];
        let correctAnswers = 0;

        // Sistema de salvamento no localStorage - VERS√ÉO CORRIGIDA
        function saveTestResults() {
            const testResults = {
                id: Date.now(),
                date: new Date().toISOString(),
                score: correctAnswers,
                total: testPlates.length,
                percentage: Math.round((correctAnswers / testPlates.length) * 100),
                answers: userAnswers,
                testType: 'ishihara'
            };

            const existingResults = JSON.parse(localStorage.getItem('spectraTestResults') || '[]');
            const uniqueResults = existingResults.filter(result => 
                result.id !== testResults.id && 
                result.date !== testResults.date
            );
            
            uniqueResults.push(testResults);
            const sortedResults = uniqueResults.sort((a, b) => new Date(b.date) - new Date(a.date));
            const recentResults = sortedResults.slice(0, 10);
            
            localStorage.setItem('spectraTestResults', JSON.stringify(recentResults));
            
            console.log('Resultados salvos no localStorage:', testResults);
            console.log('Total de resultados salvos:', recentResults.length);
        }

        function loadPreviousResults() {
            const results = JSON.parse(localStorage.getItem('spectraTestResults') || '[]');
            console.log('Resultados anteriores carregados:', results);
            return results;
        }

        // FUN√á√ïES MODIFICADAS para gerar as imagens mais n√≠tidas
        function generatePlate(plateConfig) {
            const mosaicGrid = document.getElementById('mosaicGrid');
            mosaicGrid.innerHTML = '';

            const gridSize = 24;
            const centerX = gridSize / 2;
            const centerY = gridSize / 2;
            const radius = centerX - 0.5;

            // Criar todos os pontos do mosaico
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    const dot = document.createElement('div');
                    dot.className = 'mosaic-dot';
                    
                    const distanceFromCenter = Math.sqrt(Math.pow(col - centerX, 2) + Math.pow(row - centerY, 2));
                    
                    if (distanceFromCenter <= radius) {
                        dot.style.backgroundColor = plateConfig.colors.background[Math.floor(Math.random() * plateConfig.colors.background.length)];
                    } else {
                        dot.style.backgroundColor = 'transparent';
                    }
                    
                    mosaicGrid.appendChild(dot);
                }
            }

            // Gerar padr√£o do n√∫mero
            generateNumberPattern(plateConfig.number, plateConfig.colors.number, gridSize);
        }

        function generateNumberPattern(number, colors, gridSize) {
            const patterns = {
                3: [
                    [0,0,1,1,1,1,1,1,0,0],
                    [0,1,1,1,0,0,1,1,1,0],
                    [1,1,1,0,0,0,0,1,1,1],
                    [0,0,0,0,0,0,0,1,1,1],
                    [0,0,0,1,1,1,1,1,1,0],
                    [0,0,0,1,1,1,1,1,1,0],
                    [0,0,0,0,0,0,0,1,1,1],
                    [1,1,1,0,0,0,0,1,1,1],
                    [0,1,1,1,0,0,1,1,1,0],
                    [0,0,1,1,1,1,1,1,0,0]
                ],
                5: [
                    [1,1,1,1,1,1,1,1,1,1],
                    [1,1,1,1,1,1,1,1,1,1],
                    [1,1,1,0,0,0,0,0,0,0],
                    [1,1,1,0,0,0,0,0,0,0],
                    [1,1,1,1,1,1,1,1,0,0],
                    [0,0,1,1,1,1,1,1,1,0],
                    [0,0,0,0,0,0,0,1,1,1],
                    [1,1,1,0,0,0,0,1,1,1],
                    [0,1,1,1,0,0,1,1,1,0],
                    [0,0,1,1,1,1,1,1,0,0]
                ],
                6: [
                    [0,0,1,1,1,1,1,1,0,0],
                    [0,1,1,1,0,0,1,1,1,0],
                    [1,1,1,0,0,0,0,1,1,1],
                    [1,1,1,0,0,0,0,0,0,0],
                    [1,1,1,1,1,1,1,1,0,0],
                    [1,1,1,1,1,1,1,1,1,0],
                    [1,1,1,0,0,0,0,1,1,1],
                    [1,1,1,0,0,0,0,1,1,1],
                    [0,1,1,1,0,0,1,1,1,0],
                    [0,0,1,1,1,1,1,1,0,0]
                ],
                2: [
                    [1,1,1,1,1,1,1,1,0,0],
                    [0,0,0,0,0,0,1,1,1,0],
                    [0,0,0,0,0,0,0,1,1,1],
                    [0,0,0,0,0,0,0,1,1,1],
                    [0,0,0,1,1,1,1,1,1,0],
                    [0,1,1,1,1,1,1,1,0,0],
                    [1,1,1,0,0,0,0,0,0,0],
                    [1,1,1,0,0,0,0,0,0,0],
                    [1,1,1,0,0,0,0,0,0,0],
                    [1,1,1,1,1,1,1,1,1,1]
                ],
                7: [
                    [1,1,1,1,1,1,1,1,1,1],
                    [0,0,0,0,0,0,0,1,1,1],
                    [0,0,0,0,0,0,1,1,1,0],
                    [0,0,0,0,0,1,1,1,0,0],
                    [0,0,0,0,1,1,1,0,0,0],
                    [0,0,0,1,1,1,0,0,0,0],
                    [0,0,1,1,1,0,0,0,0,0],
                    [0,1,1,1,0,0,0,0,0,0],
                    [1,1,1,0,0,0,0,0,0,0],
                    [1,1,0,0,0,0,0,0,0,0]
                ],
                8: [
                    [0,0,1,1,1,1,1,1,0,0],
                    [0,1,1,1,0,0,1,1,1,0],
                    [1,1,1,0,0,0,0,1,1,1],
                    [1,1,1,0,0,0,0,1,1,1],
                    [0,1,1,1,1,1,1,1,1,0],
                    [0,1,1,1,1,1,1,1,1,0],
                    [1,1,1,0,0,0,0,1,1,1],
                    [1,1,1,0,0,0,0,1,1,1],
                    [0,1,1,1,0,0,1,1,1,0],
                    [0,0,1,1,1,1,1,1,0,0]
                ]
            };

            const pattern = patterns[number];
            const patternHeight = pattern.length;
            const patternWidth = pattern[0].length;
            
            const startRow = Math.floor((gridSize - patternHeight) / 2);
            const startCol = Math.floor((gridSize - patternWidth) / 2);

            for (let row = 0; row < patternHeight; row++) {
                for (let col = 0; col < patternWidth; col++) {
                    if (pattern[row][col] === 1) {
                        const gridRow = startRow + row;
                        const gridCol = startCol + col;
                        
                        const dots = document.querySelectorAll('.mosaic-dot');
                        const dotIndex = gridRow * gridSize + gridCol;
                        
                        if (dots[dotIndex] && gridRow >= 0 && gridRow < gridSize && gridCol >= 0 && gridCol < gridSize) {
                            const centerX = gridSize / 2;
                            const centerY = gridSize / 2;
                            const radius = centerX - 0.5;
                            const distanceFromCenter = Math.sqrt(Math.pow(gridCol - centerX, 2) + Math.pow(gridRow - centerY, 2));
                            
                            if (distanceFromCenter <= radius) {
                                dots[dotIndex].style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                            }
                        }
                    }
                }
            }
        }

        // FUN√á√ïES ORIGINAIS (n√£o modificadas)
        function updateProgress() {
            const progress = ((currentQuestion) / testPlates.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `Quest√£o ${currentQuestion + 1} de ${testPlates.length}`;
        }

        function loadCurrentQuestion() {
            if (currentQuestion < testPlates.length) {
                generatePlate(testPlates[currentQuestion]);
                updateProgress();
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').focus();
            } else {
                showResults();
            }
        }

        function nextQuestion() {
            const answer = document.getElementById('answerInput').value.trim();
            const correctAnswer = testPlates[currentQuestion].number;
            
            userAnswers.push({
                question: currentQuestion + 1,
                userAnswer: answer,
                correctAnswer: correctAnswer,
                isCorrect: parseInt(answer) === correctAnswer,
                type: testPlates[currentQuestion].type
            });

            if (parseInt(answer) === correctAnswer) {
                correctAnswers++;
            }

            currentQuestion++;
            loadCurrentQuestion();
        }

        function skipQuestion() {
            userAnswers.push({
                question: currentQuestion + 1,
                userAnswer: 'N√£o conseguiu ver',
                correctAnswer: testPlates[currentQuestion].number,
                isCorrect: false,
                type: testPlates[currentQuestion].type
            });

            currentQuestion++;
            loadCurrentQuestion();
        }

        function showResults() {
            if (document.getElementById('resultsScreen').style.display === 'block') {
                return;
            }
            
            document.getElementById('testScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';

            const score = correctAnswers;
            const percentage = Math.round((score / testPlates.length) * 100);

            document.getElementById('scoreDisplay').innerHTML = `${score}/${testPlates.length}<br><span style="font-size: 1.5rem;">${percentage}% corretas</span>`;

            let interpretation = '';
            if (percentage >= 83) {
                interpretation = `
                    <h3>‚úÖ Vis√£o de Cores Normal</h3>
                    <p>Parab√©ns! Voc√™ conseguiu identificar a maioria dos n√∫meros corretamente. Isso indica que sua percep√ß√£o de cores est√° dentro do normal.</p>
                `;
            } else if (percentage >= 50) {
                interpretation = `
                    <h3>‚ö†Ô∏è Poss√≠vel Defici√™ncia Leve</h3>
                    <p>Voc√™ teve algumas dificuldades em identificar certos n√∫meros. Isso pode indicar uma defici√™ncia leve na percep√ß√£o de cores.</p>
                `;
            } else {
                interpretation = `
                    <h3>üîç Poss√≠vel Defici√™ncia Significativa</h3>
                    <p>Voc√™ teve dificuldade em identificar v√°rios n√∫meros. Isso pode indicar uma defici√™ncia mais significativa na percep√ß√£o de cores.</p>
                `;
            }

            const protanopiaErrors = userAnswers.filter(a => a.type === 'protanopia' && !a.isCorrect).length;
            const deuteranopiaErrors = userAnswers.filter(a => a.type === 'deuteranopia' && !a.isCorrect).length;
            const tritanopiaErrors = userAnswers.filter(a => a.type === 'tritanopia' && !a.isCorrect).length;

            if (protanopiaErrors >= 2) {
                interpretation += `<p><strong>Padr√£o detectado:</strong> Poss√≠vel dificuldade com tons de vermelho (Protanopia).</p>`;
            }
            if (deuteranopiaErrors >= 2) {
                interpretation += `<p><strong>Padr√£o detectado:</strong> Poss√≠vel dificuldade com tons de verde (Deuteranopia).</p>`;
            }
            if (tritanopiaErrors >= 1) {
                interpretation += `<p><strong>Padr√£o detectado:</strong> Poss√≠vel dificuldade com tons de azul-amarelo (Tritanopia).</p>`;
            }

            document.getElementById('resultInterpretation').innerHTML = interpretation;

            saveTestResults();
        }

        function restartTest() {
            currentQuestion = 0;
            userAnswers = [];
            correctAnswers = 0;
            
            document.getElementById('testScreen').style.display = 'block';
            document.getElementById('resultsScreen').style.display = 'none';
            
            loadCurrentQuestion();
        }

        function saveResults() {
            saveTestResults();
            alert('Resultados salvos com sucesso! üíæ\n\nVoc√™ pode visualizar seu hist√≥rico de testes no menu principal.');
        }

        // Event listeners
        document.getElementById('answerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                nextQuestion();
            }
        });

        // Carrega resultados anteriores ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadPreviousResults();
            loadCurrentQuestion();
        });
    </script>
</body>
</html>